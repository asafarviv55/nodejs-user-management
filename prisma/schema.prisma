generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  username          String?
  password          String
  roleId            Int
  role              Role      @relation(fields: [roleId], references: [id])
  isActive          Boolean   @default(true)
  isEmailVerified   Boolean   @default(false)
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  lastLoginAt       DateTime?
  failedLoginAttempts Int     @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  profile           UserProfile?
  preferences       UserPreferences?
  sessions          Session[]
  activityLogs      ActivityLog[]
  teamMemberships   TeamMember[]
  sentInvitations   Invitation[]     @relation("InvitationSender")
  passwordResets    PasswordReset[]
  verificationTokens VerificationToken[]

  @@index([email])
  @@index([isActive])
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  isSystem    Boolean      @default(false)
  users       User[]
  permissions RolePermission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  resource    String
  action      String
  description String?
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model UserProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName   String?
  lastName    String?
  phone       String?
  avatarUrl   String?
  bio         String?  @db.Text
  jobTitle    String?
  department  String?
  timezone    String   @default("UTC")
  language    String   @default("en")
  dateOfBirth DateTime?
  address     String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserPreferences {
  id                    Int      @id @default(autoincrement())
  userId                Int      @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(true)
  marketingEmails       Boolean  @default(false)
  securityAlerts        Boolean  @default(true)
  weeklyDigest          Boolean  @default(true)
  theme                 String   @default("system")
  compactView           Boolean  @default(false)
  showOnlineStatus      Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Team {
  id          Int          @id @default(autoincrement())
  name        String
  slug        String       @unique
  description String?      @db.Text
  avatarUrl   String?
  isActive    Boolean      @default(true)
  ownerId     Int
  maxMembers  Int          @default(50)
  members     TeamMember[]
  invitations Invitation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([slug])
  @@index([ownerId])
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  teamId    Int
  userId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      TeamRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Invitation {
  id          Int              @id @default(autoincrement())
  email       String
  token       String           @unique
  teamId      Int?
  team        Team?            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  senderId    Int
  sender      User             @relation("InvitationSender", fields: [senderId], references: [id])
  role        TeamRole         @default(MEMBER)
  status      InvitationStatus @default(PENDING)
  message     String?          @db.Text
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime         @default(now())

  @@index([token])
  @@index([email])
  @@index([status])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

model Session {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  deviceName   String?
  deviceType   String?
  browser      String?
  ipAddress    String?
  location     String?
  isActive     Boolean  @default(true)
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([isActive])
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      String
  resource    String
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  status      String   @default("success")
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model VerificationToken {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String           @unique
  type      VerificationType
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([token])
  @@index([userId])
}

enum VerificationType {
  EMAIL
  PHONE
  TWO_FACTOR_SETUP
}
